# 2. Шарова архітектура (Layered Architecture)

**Date:** 2025-12-03
**Status:** Accepted

## Context
Для забезпечення підтримки коду в рамках Модульного Моноліту нам необхідно ізолювати бізнес-логіку від інфраструктури (веб-фреймворку, бази даних). Без чітких кордонів код швидко перетвориться на неструктурований ("Big Ball of Mud").

## Decision
Ми приймаємо тришарову архітектуру з однонаправленим потоком залежностей.

### Структура шарів

1.  **Presentation Layer (`src/api/`)**
    * **Вміст:** Роути (Routes/Controllers), схеми DTO (Pydantic/Marshmallow), обробка HTTP-запитів, коди відповідей.
    * **Відповідальність:** Прийняти запит -> Валідувати DTO -> Викликати Service -> Повернути відповідь.

2.  **Application Layer (`src/service/`)**
    * **Вміст:** Класи сервісів (`TodoService`), сценарії використання (Use Cases), транзакційні скрипти.
    * **Відповідальність:** Бізнес-логіка, оркестрація, виклик репозиторіїв, мапінг даних (Entity <-> DTO).

3.  **Domain Layer (`src/domain/`)**
    * **Вміст:** Сутності (Entities), Об'єкти-значення (Value Objects), винятки домену, інтерфейси (порти).
    * **Відповідальність:** Чиста бізнес-логіка, інваріанти сутностей. Цей шар не залежить ні від чого.

## Dependency Rules (Напрямок залежностей)
Залежності дозволені **тільки зверху вниз**:

`API` -> `Service` -> `Domain`

## Forbidden Connections (Заборонені зв'язки)
Суворо заборонено:
1.  **API звертається в БД:** Контролери не повинні виконувати SQL-запити або викликати методи ORM напряму. Вся робота з даними — через Service.
2.  **Domain залежить від Framework:** У папці `domain/` не повинно бути імпортів з `flask`, `sqlalchemy` (окрім декларативних моделей, якщо це Active Record, але в ідеалі — чисті класи), `werkzeug` тощо.
3.  **Circular Dependency:** Domain не може імпортувати Service або API. Service не може імпортувати API.
4.  **Leakage of Domain:** Сервіс не повинен повертати об'єкти ORM (наприклад, SQLAlchemy Model) безпосередньо в контролер, якщо це призводить до "Лінивого завантаження" (Lazy Loading) у view-шарі. Дані мають бути перетворені в прості структури або DTO.

## Consequences
* Зміни у веб-фреймворку (наприклад, заміна Flask на FastAPI) зачіпають лише `src/api`.
* Логіку в `src/service` та `src/domain` можна тестувати юніт-тестами без підняття сервера.